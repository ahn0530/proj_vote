<% layout('layouts/boilerplate') %>

<div class="container mt-4">
  <div class="card">
    <div class="card-body">
      <small class="text-muted"><%= board.category %></small>
      <h4 class="card-title mt-2"><%= board.title %></h4>
      <h6 class="card-subtitle mb-2 text-muted">
        <%= board.author.username %> â€¢ <%= board.createdAt.toLocaleString() %>
      </h6>
      <p class="card-text mt-3"><%= board.content %></p>
      <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
          <span class="me-3">ğŸ‘ <%= board.viewCount %></span>
          <span class="me-3" id="likeCount">â¤ï¸ <%= board.likeCount %></span>
          <span id="commentCountBrief">ğŸ’¬ <%= board.comments.length %></span>
        </div>
        <button class="btn btn-outline-danger btn-sm" id="likeButton" onclick="handleLike()">
          â¤ï¸ ì¢‹ì•„ìš”
        </button>
      </div>
      <% if (user && user.id === board.author.id) { %>
        <div class="mt-3">
          <a href="/board/<%= board.id %>/edit" class="btn btn-primary btn-sm">ìˆ˜ì •</a>
          <button class="btn btn-danger btn-sm" onclick="deleteBoard()">ì‚­ì œ</button>
        </div>
      <% } %>
    </div>
  </div>


  <div class="mt-4">
    <h6 id="commentCount">ëŒ“ê¸€ <%= board.comments.length %>ê°œ</h6>
    <div id="commentsList">
      <% if (board.comments && board.comments.length > 0) { %>
        <% board.comments.forEach(comment => { %>
          <div class="card mb-2" id="comment-<%= comment.id %>">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted"><%= comment.author.username %></h6>
              <p class="card-text comment-content"><%= comment.content %></p>
              <small class="text-muted"><%= comment.createdAt.toLocaleString() %></small>
              <% if (user && user.id === comment.author.id) { %>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary edit-comment" data-comment-id="<%= comment.id %>">ìˆ˜ì •</button>
                  <button class="btn btn-sm btn-outline-danger delete-comment" data-comment-id="<%= comment.id %>">ì‚­ì œ</button>
                </div>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      <% } %>
    </div>
    
    <% if (user) { %>
      <form onsubmit="addComment(event)" class="mt-3">
        <div class="input-group">
          <input type="text" class="form-control" id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
          <button class="btn btn-primary" type="submit">ë“±ë¡</button>
        </div>
      </form>
    <% } else { %>
      <p class="mt-3">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/users/login">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.</p>
    <% } %>
  </div>
</div>

<script>
  let isLiked = <%= locals.user ? board.likedByUsers.some(u => u.id === locals.user.id) : false %>;
  
  // ê²Œì‹œê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤...
  async function editBoard() {
    window.location.href = `/board/<%= board.id %>/edit`;
  }
  
  async function deleteBoard() {
    if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
    try {
      const response = await fetch(`/board/<%= board.id %>`, {
        method: 'DELETE',
        credentials: 'include'
      });
  
      const result = await response.json();
  
      if (response.ok) {
        alert(result.message);
        window.location.href = '/board/index';
      } else {
        throw new Error(result.message || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Delete board error:', error);
      alert(error.message || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }
  
  // ì¢‹ì•„ìš” ê´€ë ¨ í•¨ìˆ˜ë“¤...
  document.addEventListener('DOMContentLoaded', function() {
    updateLikeButton();
    attachCommentEventListeners(); // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  });
  
  function updateLikeButton() {
    const likeButton = document.getElementById('likeButton');
    if (!likeButton) return;
  
    if (isLiked) {
      likeButton.classList.add('btn-danger');
      likeButton.classList.remove('btn-outline-danger');
    } else {
      likeButton.classList.remove('btn-danger');
      likeButton.classList.add('btn-outline-danger');
    }
  }
  
  async function handleLike() {
    try {
      const response = await fetch(`/board/<%= board.id %>/like`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include'
      });
      if (response.ok) {
        const result = await response.json();
        document.getElementById('likeCount').textContent = `â¤ï¸ ${result.likeCount}`;
        isLiked = result.liked;
        updateLikeButton();
      } else if (response.status === 401) {
        alert('ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/users/login';
      } else {
        throw new Error('Failed to toggle like');
      }
    } catch (error) {
      console.error('Toggle like error:', error);
      alert('ì¢‹ì•„ìš” í† ê¸€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }
  
  // ëŒ“ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤...
  async function addComment(event) {
    event.preventDefault();
    const contentInput = document.getElementById('commentContent');
    const content = contentInput.value;
    
    try {
      const response = await fetch(`/board/<%= board.id %>/comment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content }),
        credentials: 'include'
      });
      
      if (response.ok) {
        const newComment = await response.json();
        addCommentToDOM(newComment);
        contentInput.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        updateCommentCount(1);
        
        // "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
        const noCommentsMessage = document.querySelector('#commentsList p');
        if (noCommentsMessage && noCommentsMessage.textContent === 'ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.') {
          noCommentsMessage.remove();
        }
      } else if (response.status === 401) {
        alert('ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/users/login';
      } else {
        throw new Error('Failed to add comment');
      }
    } catch (error) {
      console.error('Add comment error:', error);
    }
  }
  
  function addCommentToDOM(comment) {
    const commentsList = document.getElementById('commentsList');
    const commentElement = document.createElement('div');
    commentElement.className = 'card mb-2';
    commentElement.id = `comment-${comment.id}`;
    
    commentElement.innerHTML = `
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">${comment.author.username}</h6>
        <p class="card-text comment-content">${comment.content}</p>
        <small class="text-muted">${new Date(comment.createdAt).toLocaleString()}</small>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary edit-comment" data-comment-id="${comment.id}">ìˆ˜ì •</button>
          <button class="btn btn-sm btn-outline-danger delete-comment" data-comment-id="${comment.id}">ì‚­ì œ</button>
        </div>
      </div>
    `;
    
    // ìƒˆ ëŒ“ê¸€ì„ ëª©ë¡ì˜ ë§¨ ìœ„ì— ì¶”ê°€
    if (commentsList.firstChild) {
      commentsList.insertBefore(commentElement, commentsList.firstChild);
    } else {
      commentsList.appendChild(commentElement);
    }
  
    // ìƒˆ ëŒ“ê¸€ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    attachCommentEventListeners(commentElement);
  }
  
  // ëŒ“ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜
  function attachCommentEventListeners(container = document) {
    // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    container.querySelectorAll('.edit-comment').forEach(button => {
      button.addEventListener('click', handleCommentEdit);
    });
  
    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    container.querySelectorAll('.delete-comment').forEach(button => {
      button.addEventListener('click', handleCommentDelete);
    });
  }
  
  // ëŒ“ê¸€ ìˆ˜ì • í•¸ë“¤ëŸ¬
  async function handleCommentEdit(e) {
    const commentId = e.target.getAttribute('data-comment-id');
    const commentCard = document.getElementById(`comment-${commentId}`);
    const contentElement = commentCard.querySelector('.comment-content');
    const currentContent = contentElement.textContent;
  
    const input = document.createElement('textarea');
    input.value = currentContent;
    input.className = 'form-control mb-2';
    contentElement.replaceWith(input);
  
    const saveButton = document.createElement('button');
    saveButton.textContent = 'ì €ì¥';
    saveButton.className = 'btn btn-sm btn-primary mr-2';
    
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'ì·¨ì†Œ';
    cancelButton.className = 'btn btn-sm btn-secondary';
  
    saveButton.addEventListener('click', async () => {
      try {
        const response = await fetch(`/board/<%= board.id %>/comment/${commentId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ content: input.value }),
          credentials: 'include'
        });
  
        if (response.ok) {
          const updatedComment = await response.json();
          contentElement.textContent = updatedComment.content;
          input.replaceWith(contentElement);
          saveButton.remove();
          cancelButton.remove();
        } else {
          throw new Error('Failed to update comment');
        }
      } catch (error) {
        console.error('Update comment error:', error);
        alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  
    cancelButton.addEventListener('click', () => {
      input.replaceWith(contentElement);
      saveButton.remove();
      cancelButton.remove();
    });
  
    commentCard.querySelector('.card-body').appendChild(saveButton);
    commentCard.querySelector('.card-body').appendChild(cancelButton);
  }
  
  // ëŒ“ê¸€ ì‚­ì œ í•¸ë“¤ëŸ¬
  async function handleCommentDelete(e) {
    if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
    const commentId = e.target.getAttribute('data-comment-id');
    try {
      const response = await fetch(`/board/<%= board.id %>/comment/${commentId}`, {
        method: 'DELETE',
        credentials: 'include'
      });
  
      if (response.ok) {
        const commentElement = document.getElementById(`comment-${commentId}`);
        if (commentElement) {
          commentElement.remove();
          updateCommentCount(-1);
          
          // ëŒ“ê¸€ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
          const commentsList = document.getElementById('commentsList');
          if (commentsList.children.length === 0) {
            commentsList.innerHTML = '<p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
        }
      } else {
        throw new Error('Failed to delete comment');
      }
    } catch (error) {
      console.error('Delete comment error:', error);
      alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }
  
  function updateCommentCount(change) {
    const commentCountElement = document.getElementById('commentCount');
    const commentCountBriefElement = document.getElementById('commentCountBrief');
    const currentCount = parseInt(commentCountElement.textContent.match(/\d+/)[0]);
    const newCount = currentCount + change;
    commentCountElement.textContent = `ëŒ“ê¸€ ${newCount}ê°œ`;
    commentCountBriefElement.textContent = `ğŸ’¬ ${newCount}`;
  }
  </script>